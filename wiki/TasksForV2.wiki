#summary CoveredCalc v2 のタスク
#labels Phase-Design,Featured

CoveredCalc は 2003 年ごろからあまり明確な設計もないまま少しずつ実装されていきました。
まだまだ拡張したい機能はたくさんあり、また、その拡張のためにすでに実装している部分もあるのですが、
きれいに設計できていないため拡張に手間がかかる状態です。

それと平行して、世の中の事情もずいぶん変わってきました。
Windows 環境では、Windows 98 などは過去の OS であり、最近では Windows 98 をサポートしないソフトも多くあります。
さらに 64 ビット版の Windows もリリースされていて、これを無視できない状況になってきています。
一方、BeOS 環境ではオープンソースの Haiku のαリリースが迫っています。

設計を見直すのにはちょうどいいタイミングだと思います。
そこで、CoveredCalc の次期バージョン（仮にv2と呼びます）として、主に内部の構造などの修正を検討しています。
とはいっても、余った時間に作業しているだけなので、あまり大きな修正は行えませんが‥‥。

ここに書いたタスクは最終的にすべて実現するかどうかはわかりません。
また、タスクの番号に優先順序的な意味はありません。

== ~~タスク1: Windows 版の Unicode ビルド対応~~ (終了) ==

*Windows 版を Unicode ビルドできるようにします。*

現在の Windows 版は ANSI/MBCS ビルドです。
ANSI/MBCS ビルドではユーザーが利用している環境のコードページに従った文字しか表示できません。
英語版 Windows では、たとえ日本語フォントが入っていたとしても日本語は表示できません（たぶん）。
Unicode ビルドにすると、プログラム内部の文字列表現が Unicode になるため、こういった問題はなくなります。言語の混在も可能です。
ただし、Unicode ビルドにすると Windows 9X 系（98/Me）で動作しません。
理想的には ANSI/MBCS ビルドと Unicode ビルドをコンパイルオプションで切り替えられるようにして
Windows 9X 系向けと Windows NT 系（NT4/2000/XP/Vista）の 2 つのバイナリをリリースするのが
いいのですが、もう 9X 系は切り捨ててもいいように思っています。

  * ANSI/MBCS ビルドと Unicode ビルドをコンパイルオプションで切り替えられるようにする。
  * {{{AChar}}} → {{{char}}}/{{{wchar_t}}}、{{{AStr}}} → {{{char*}}}/{{{wchar_t*}}}、{{{ConstAStr}}} → {{{const char*}}}/{{{const wchar_t*}}} で定義
  * 文字列クラスの Unicode 対応
  * HrnLib 内の Unicode 対応
  * Windows 9X 系向けバイナリのリリースは今後行わない予定。

== タスク2: Windows 版の Win64 対応準備 ==

*Windows 版について、VC++ のビルドオプションから「Win64互換チェック無効」スイッチを外して警告が出ないようにします。*

現在の Windows 版は Win32 のことしか考えていません。
将来、64ビット版 Windows に移行しやすいように今のうちに Win64 対応の準備をしておきます。
ただし、64ビット版のリリースは行いません。（手元に64ビット版を作るコンパイラも、テスト環境もないためです）

  * VC++ のビルドオプションから「Win64互換チェック無効」スイッチを外して警告が出ないようにする。

== タスク3: Haiku 版の作成 ==

*BeOS 版ファミリーの 1 つとして Haiku 版を作成します。*

BeOS 自体は非常に古い OS で、今後のバージョンアップも期待できません。
一方、[http://www.haiku-os.org Haiku] がα版リリースの手前まで進んでいます。
CoveredCalc も Haiku がリリースされた後はそちらをメインの開発軸にするつもりです。
Haiku 上で開発が行える環境になっているので、そろそろ Haiku 上での開発も行ってみます。

  * ~~Haiku 向け開発環境の構築~~
  * ~~makefile-engine を利用しない makefile の作成~~
  * ~~BeIDE を利用しない開発サイクルの模索（Peを利用？）~~
  * Haiku 版で出てくるであろう問題点への対応。

== ~~タスク4: ソースのIncludeディレクトリの廃止~~ (終了) ==

*Includeディレクトリに集めてあるヘッダファイルを各ディレクトリに再配置してIncludeディレクトリを廃止します。*

現在、ヘッダファイルはすべてIncludeというディレクトリの中に配置しています。
コンパイル時のインクルードパスを定義するのが楽だからという理由でこうなっていましたが、
ファイルが増えてくるにつれてファイルを探すのに手間がかかり扱いづらくなってきました。
ソースファイルと同じようにヘッダファイルも機能でわけたディレクトリ（ソースファイルと同じディレクトリ）に
配置するようにし、Includeディレクトリは廃止します。

== タスク5: メインウィンドウのダイアログ表示の設計を改善 ==

*メインウィンドウのダイアログ表示までのコードがムダに複雑なので作りを改善します。*

  * UIController <|-- WinSkinWindow <|-- WinMainWindow と、UIManager <|-- MainUIManager による操作が非常にまわりくどい。
  * UIContoller と UIManager に分けること自体は問題ないと思うが、メインウィンドウに特化したUI操作までUIControllerを経由してやろうとするからムリが出る（ダイアログ表示、メニュー表示など）。
  * UIController（一般的なUI操作）と、MainUIController（メインウィンドウに特化したUI操作）の2種類のインタフェースを作って、 WinSkinWindowはUIController、WinMainWindowはMainUIContorllerを実装するようにしたらどうか。 MainUIManagerは、UIControllerとMainUIControllerの両方を使って操作する。
  * BeDialog::Init()がvirtualなのもこれが原因か？ BeEditKeymapDlg::Init()がものすごく不要な感じなので困る。つーか呼ばれたらマズいし。

== タスク6: 言語ファイルの見直し ==

*言語ファイルを見直します。*

  * 英語の言語ファイルを必須にして、それ以外の言語の言語ファイルは英語からの差分という扱いにする。つまり、英語以外の言語ファイルで定義されていないものについては英語の言語ファイルの内容を利用する。
  * Windows 版のダイアログレイアウトも言語ファイルで対応。ダイアログテンプレートリソースは利用するが、その後言語ファイルの指定に応じて配置やフォントを変更する。（フォントは言語ファイルの方でOSごとに分けて指定できる必要があるのか？）
  * BeOS 版のダイアログレイアウトの記述についてピクセル単位ではなく DLU（ダイアログユニット）を利用するように。DLU は [http://support.microsoft.com/kb/125681/EN-US/ Windows のもの] を参考にする。

== タスク7: アイコンを一新 ==

*せっかくなのでアイコンを一新します。（あんまりやる気ないけど）*

Haiku 版用にベクターアイコンが用意できればいいなあと思います。
現在のアイコンは以前に SHIN-ICHI さんにデザインしていただいたものですが、ベクターアイコンとしてデザインしてくれる人がいるなら、アイコンを一新してもいいかなあと思っています。デザイナー募集。

== タスク8: デフォルトカバーを一新 ==

*せっかくなのでデフォルトカバーを一新*

タスク7とほとんど一緒です。
ただし、デフォルトカバーは機能を追加するたびに変更が入ることが多いので継続してデザインできる必要があります。

== ~~タスク9: Windows 版のコンパイラを VC++ 2008 に~~ (終了) ==

*Windows 版のコンパイラを VC++ 2008 Express Edition にします。*

現状の Windows 版は Visual Studio 2005 Standard Edition の Visual C++ を使ってビルドしています。
現時点で Visual C++ の最新版は Visual C++ 2008 (Visual Studio 2008) なので、その無料版である Visual C++ 2008 Express Edition にコンパイラを変更します。

 * ソリューションファイル({{{*.sln}}})、プロジェクトファイル({{{*.vcproj}}}) のアップグレード
 * コンパイルエラーの修正
 * リソースエディタの調達（Express Edition にはリソースエディタが付属しないため）